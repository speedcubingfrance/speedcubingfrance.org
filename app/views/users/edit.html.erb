<% provide(:title, "Mon profil") %>
<% is_admin = current_user.admin? %>
<h1><%= @user.name %> - <%= @user.country_name %> <%= flag_icon(@user.country_iso2) %></h1>
<% last_sub = @user.last_subscription %>
<% if last_sub&.active? %>
  <div class="alert alert-success">
    Vous êtes membre de l'AFS jusqu'au <%= l(last_sub.until) %>.
  </div>
<% elsif last_sub %>
  <div class="alert alert-warning">
    Vous n'êtes plus membre de l'AFS depuis le <%= l(last_sub.until) %>.
  </div>
<% else %>
  <div class="alert alert-danger">
    Vous n'êtes pas membre de l'AFS.
  </div>
<% end %>
<div class="alert alert-warning">
  Note : vous devez avoir une cotisation active pour que les champs marquées d'un * soient pris en compte. Vous serez automatiquement retiré·e des listes de diffusion si votre adhésion se termine sans être renouvelée.
  <% if last_sub&.active? %>
      Étant actuellement membre de l'association, l'activation de ces notifications/listes de diffusion devrait fonctionner.
  <% else %>
      N'étant actuellement pas membre de l'association, l'activation de ces notifications/listes de diffusion NE fonctionnera PAS.
  <% end %>
</div>
<%= simple_form_for @user, wrapper: :horizontal_form, html: { class: "mb-4 user-edit-form" } do |f| %>
  <%= f.input :friendly_delegate_status, as: :display, label: false %>

  <%= f.error_notification message: "Le formulaire est invalide. Merci de corriger les erreurs ci dessous." %>

  <%= f.input :wca_id, as: :display %>
  <%= f.input :friendly_birthdate, as: :display %>
  <%= f.input :city %>
  <%= f.input :admin, disabled: !is_admin %>
  <%= f.input :communication, disabled: !is_admin %>
  <%= f.input :french_delegate, disabled: !is_admin %>
  <%= f.input :notify_subscription %>
  <%= f.input :discussion_subscription %>
  <%= f.input :newsletter_subscription %>
  <% if current_user&.can_edit_user?(@user) %>
    <%= f.button :submit %>
  <% end %>
<% end %>

<h2>Cotisations</h2>
<div class="alert alert-info">
  Les cotisations sont importées manuellement et périodiquement par les membres du bureau.
  <br/>
  Si vous pensez que les informations ci-dessous sont erronées, merci de contacter l'ensemble du bureau via l'adresse <%= mail_to "bureau@speedcubingfrance.org" %>.
</div>
<% if @user.subscriptions.empty? %>
  <div class="alert alert-warning">
    <p>
      Vous n'avez aucune cotisation enregistrée.
      Rendez vous sur <%= link_to "HelloAsso", "https://www.helloasso.com/associations/association-francaise-de-speedcubing", target: "_blank" %> pour adhérer !.
    </p>
  </div>
<% else %>
  <table class="table table-bordered table-hover">
    <tbody>
      <% @user.subscriptions.reverse_each do |s| %>
        <% tr_class = s.over? ? "warning" : "success" %>
        <tr class="table-<%= tr_class %>">
          <td>
            Payée le <%= l(s.payed_at.to_date) %>, cette cotisation
            <% if s.over? %>
              n'est plus active.
            <% else %>
              est toujours active.
            <% end %>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
<% end %>
